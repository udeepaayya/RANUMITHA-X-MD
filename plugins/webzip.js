const { cmd } = require('../command');
const axios = require("axios");
const fs = require("fs");
const path = require("path");

cmd({
    pattern: "web2zip",
    alias: ["getzip", "sitezip"],
    react: "ğŸ“",
    desc: "Download any website as a ZIP file",
    category: "download",
    use: ".web2zip <url>",
    filename: __filename
}, async (conn, m, mek, { from, q, reply }) => {
    try {
        if (!q) return reply("âŒ *Please provide a website link!*\n\nExample: *.web2zip https://whiteshadow-md.vercel.app/*");

        reply("â³ *Fetching and zipping the website...*\nPlease wait a few seconds âš™ï¸");

        // Call ElrayyXml API
        const apiUrl = `https://api.elrayyxml.web.id/api/tools/webtozip?url=${encodeURIComponent(q)}`;
        const { data } = await axios.get(apiUrl);

        if (!data.status) return reply("âŒ *Failed to fetch website data!*");

        const downloadUrl = data.result?.downloadUrl;
        const fileName = (data.result?.url?.replace(/https?:\/\//, '').split('/')[0] || "website") + ".zip";

        if (!downloadUrl) return reply("âš ï¸ *No download link received from API!*");

        // Download the ZIP file
        const tempPath = path.join(__dirname, `../temp/${fileName}`);
        const writer = fs.createWriteStream(tempPath);

        const response = await axios({
            url: downloadUrl,
            method: 'GET',
            responseType: 'stream'
        });

        response.data.pipe(writer);

        writer.on('finish', async () => {
            await conn.sendMessage(from, {
                document: fs.readFileSync(tempPath),
                mimetype: "application/zip",
                fileName: fileName,
                caption: `âœ… *Website ZIP Generated by RANUMITHA-X-MD*\n\nğŸŒ URL: ${data.result.url}\nğŸ“¦ Files: ${data.result.copiedFilesAmount}\nğŸ‘¨â€ğŸ’» Author: ElrayyXml\n\n> Â© Powerd by ğ—¥ğ—”ğ—¡ğ—¨ğ— ğ—œğ—§ğ—›ğ—”-ğ—«-ğ— ğ—— ğŸŒ›`
            }, { quoted: mek });

            fs.unlinkSync(tempPath);
        });

        writer.on('error', (err) => {
            console.error(err);
            reply("âŒ *Error while saving ZIP file.*");
        });

    } catch (e) {
        console.error(e);
        reply("âŒ *Something went wrong while fetching the website!*");
    }
});
